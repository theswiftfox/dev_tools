<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <script type="text/javascript">
        // Get the modal
        var modal = document.getElementById('login_form');

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function showLoginForm(show) {
            let loginForm = document.getElementById('login_form');
            if (show) {
                loginForm.style.display = 'block';
            } else {
                loginForm.style.display = 'none';
            }
        }

        function getUuid() {
            var http = new XMLHttpRequest();
            http.open('GET', '/fn/uuid');
            http.send();
            http.onreadystatechange = function () {
                if (http.readyState == 4 && this.status == 200) {
                    document.getElementById('uuidField').innerHTML = http.responseText
                }
            }
        }
        function formatJson() {
            let box = document.getElementById('jsonBox');
            var json = JSON.parse(box.value)
            box.value = JSON.stringify(json, null, 4);
        }

        function toggleVisible(id) {
            var x = document.getElementById(id);
            if (x.className.indexOf("w3-show") == -1) {
                x.className += " w3-show";
            } else {
                x.className = x.className.replace(" w3-show", "");
            }
        }

        function login() {
            let user = document.getElementById('username').value;
            let pw = document.getElementById('password').value;

            var object = {};
            object['username'] = user;
            object['password'] = pw;

            fetch('/fn/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(object)
            })
                .then(response => response.json())
                .catch(err => Console.log('Request failed: ' + err))
                .then(data => {
                    showLoginForm(false);
                    sessionStorage.setItem('token', data.token);
                    loadNotes();
                });
        }

        function loadNotes() {
            let token = sessionStorage.getItem('token');
            if (token == null) {
                w3.show('#loginBtn');
                w3.hide('#logoutBtn');
                w3.hide('#saveNotesBtn');
                return;
            } else {
                w3.hide('#loginBtn');
                w3.show('#logoutBtn');
            }

            fetch('/fn/notes', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (response.status == 401) {
                        sessionStorage.removeItem('token');
                        document.getElementById('notes_container').innerHTML = '';
                        w3.show('#loginBtn');
                        w3.hide('#logoutBtn');
                        w3.hide('#saveNotesBtn');
                        return '';
                    } else {
                        return response.text();
                    }
                })
                .then(data => {
                    document.getElementById('notes_container').innerHTML = data;
                    w3.show('#saveNotesBtn');
                });
        }

        function logout() {
            sessionStorage.removeItem('token');
            document.getElementById('notes_container').innerHTML = '';
            w3.show('#loginBtn');
            w3.hide('#logoutBtn');
            w3.hide('#saveNotesBtn');
        }

        function saveNotes() {
            let noteHtml = document.getElementsByClassName('note');
            var notes = new Array();
            Array.from(noteHtml).forEach(elem => {
                let t = elem.childNodes[1].innerText;
                let c = elem.childNodes[3].innerText;
                let note = { id: parseInt(elem.dataset.id), creator: elem.dataset.creator, title: t, content: c }
                notes.push(note);
            });

            fetch('/fn/notes', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + sessionStorage.getItem('token'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ notes: notes })
            })
                .then(response => { })
        }
    </script>
</head>

<body onload="loadNotes();">
    <header class="w3-container w3-bar w3-gray">
        <h1 class="w3-left">ðŸ’» Dev Utils ðŸ”¨</h1>
        <button id="loginBtn" class="w3-button w3-teal w3-right" onclick="showLoginForm(true);">Login</button>
        <button id="logoutBtn" class="w3-button w3-teal w3-right" onclick="logout();">Logout</button>
    </header>
    <div class="w3-row">
        <div class="w3-twothird">
            <div class="w3-container">
                <div class="w3-panel w3-card-2 w3-margin-bottom" style="width:100%;max-width: 800px;">
                    <h3 onclick="toggleVisible('json-content')">JSON</h3>
                    <div class="w3-hide w3-show" id="json-content">
                        <textarea id="jsonBox" rows=10 style="resize: vertical; width:100%;"></textarea><br>
                        <button class="w3-btn w3-ripple w3-teal w3-round" onclick="formatJson()">Format</button><br>
                        <p></p>
                    </div>
                </div>
                <div class="w3-panel w3-card-2 w3-margin-bottom" style="width:92%;max-width: 400px;">
                    <h3 onclick="toggleVisible('uuid-content')">UUID</h3>
                    <div class="w3-hide w3-show" id="uuid-content">
                        <textarea readonly id="uuidField" cols=35 rows=1 style="resize: none"
                            class="w3-container w3-border-top w3-border-bottom w3-border-green"></textarea><br>
                        <button class="w3-btn w3-ripple w3-teal w3-round" onclick="getUuid()">Generate</button>
                        <p></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="w3-third">
            <p></p>
            <div class="w3-container">
                <div id="notes_container"></div>
                <button id="saveNotesBtn" class="w3-button w3-teal w3-right" onclick="saveNotes();">Save All</button>
            </div>
        </div>
    </div>
    <div id="login_form" class="w3-modal">
        <div class="w3-modal-content w3-card-4 w3-animate-zoom" style="max-width: 400px;">
            <div class="w3-container">
                <p></p>
                <label for="username"><b>Username</b></label>
                <input class="w3-input w3-border w3-margin-bottom" type="text" placeholder="Enter Username"
                    id="username" required>
                <label for="password"><b>Password</b></label>
                <input class="w3-input w3-border" type="password" placeholder="Enter Password" id="password" required>
                <button class="w3-button w3-block w3-green w3-section w3-padding" onclick="login();">Login</button>
            </div>

            <div class="w3-container w3-border-top w3-padding-16 w3-light-grey">
                <button type="button" class="w3-button w3-red" onclick="showLoginForm(false);">Cancel</button>
            </div>
        </div>
    </div>
</body>